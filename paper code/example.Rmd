---
title: "example"
output: html_document
date: "2023-02-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#=====================================================================
# Loading data and packages -- 
#   assumes "3D_CGR/paper code" is the current working directory
#=====================================================================

source("./data/sequences.R")
source("./R/functions.R")

library(reshape2)
library(msa) # From Bioconductor
library(ape)
library(phangorn)
library(tidyverse)
library(ggplot2)
library(ggdendro)

```

```{r, dpi = 400}
#####################################################################
# Example DNA sequences analyzed by 3D CGR / paper reproduction
# This code does not run in parallel and the section on volume intersection
# can take a while to run.
# By: Stephanie Young <syoung2@sdsu.edu> <syoung49@its.jnj.com>
#####################################################################

#=====================================================================
# Clustal Omega + p-distance results for comparison
#=====================================================================

# Function to align the sequences

clustal_omega <- function(dna_seq, outgroup = NULL){
  msa(dna_seq, type = "dna", method = "ClustalOmega", order = "input") |> 
    msaConvert(type = "ape::DNAbin") |> ape::dist.gene() |> # can also use dist.p() from the phangorn package. 
    (\(x)x/max(x))() # distances rescaled because bionj does not like distances > 100
}

# Heatmap function

hm <- function(distances, ...){
  dat <- distances |> as.matrix() |> reshape2::melt(value.name = "distance")
  # tri <- distances |> as.matrix() |> upper.tri(diag = T) |> reshape2::melt() |> pull(value)
  # dat <- dat[tri, , drop = F]
  dat |> 
    ggplot() + 
    geom_tile(aes(x = Var1, y = Var2, fill = distance)) + 
    scale_fill_distiller(palette = "Spectral", ...) +
    theme_light() + 
    theme(
      axis.text.x = element_text(angle = 90, vjust = .5, hjust = 1), 
      axis.title.x = element_blank(), 
      axis.title.y = element_blank(), 
      legend.position = "bottom"
    ) +
    coord_fixed()
}


clustal_omega(beta_seq) |> hm() 
clustal_omega(beta_seq) |> bionj() |> root("gallus") |> plot()
clustal_omega(beta_seq) |> fastme.bal() |> root("gallus") |> plot()

clustal_omega(nadh) |> hm(trans = "exp") # transformation of color to facilitate visualization
clustal_omega(nadh) |> bionj() |> root("Saimiri sciureus") |> plot()
clustal_omega(nadh) |> fastme.bal() |> root("Saimiri sciureus") |> plot()


clustal_omega(yin_fas[-(1:7)]) |> hm()
clustal_omega(yin_fas[-(1:7)]) |> bionj() |> plot() 
clustal_omega(yin_fas[-(1:7)]) |> fastme.bal() |> plot()


align_plots_column <- function (...) {
    pl <- list(...)
    stopifnot(do.call(all, lapply(pl, inherits, "gg")))
    gl <- lapply(pl, ggplotGrob)
    bind2 <- function(x, y) gtable:::cbind_gtable(x, y, "first")
    combined <- Reduce(bind2, gl[-1], gl[[1]])
    wl <- lapply(gl, "[[", "heights")
    combined$heights <- do.call(grid::unit.pmax, wl)
    grid::grid.newpage()
    grid::grid.draw(combined)
}

align_plots_row <- function (...) {
    pl <- list(...)
    stopifnot(do.call(all, lapply(pl, inherits, "gg")))
    gl <- lapply(pl, ggplotGrob)
    bind2 <- function(x, y) gtable:::rbind_gtable(x, y, "first")
    combined <- Reduce(bind2, gl[-1], gl[[1]])
    wl <- lapply(gl, "[[", "widths")
    combined$widths <- do.call(grid::unit.pmax, wl)
    grid::grid.newpage()
    grid::grid.draw(combined)
}

align_plots_column(
  clustal_omega(beta_seq) |> hm(),
  clustal_omega(nadh) |> hm(trans = "exp"),  
  clustal_omega(yin_fas[-(1:7)]) |> hm()
  )


```

```{r}

#=====================================================================
# Shape signature results 
#=====================================================================

beta_cg <- lapply(beta_seq, seq_to_cgr)  
nadh_cg <- lapply(nadh, seq_to_cgr)  
sim_fas <- yin_fas[-(1:7)]
names(sim_fas) <- gsub("^B$", "Original", names(sim_fas))
names(sim_fas) <- gsub("B/", "", names(sim_fas))
sim_cg <- lapply(sim_fas, seq_to_cgr) 

cgr_distance2(beta_cg, frac = 1) |> hm()
cgr_distance2(beta_cg, frac = 1) |> bionj() |> ape::root("gallus") |> plot()
cgr_distance2(beta_cg, frac = 1) |> fastme.bal() |> root("gallus") |> plot() 

cgr_distance2(beta_cg, frac = 1/15) |> hm()
cgr_distance2(beta_cg, frac = 1/15) |> bionj() |> ape::root("gallus") |> plot()
cgr_distance2(beta_cg, frac = 1/15) |> fastme.bal() |> root("gallus") |> plot() 

cgr_distance2(nadh_cg, frac = 1) |> hm()
cgr_distance2(nadh_cg, frac = 1) |> bionj() |> root("Saimiri sciureus") |> plot()
cgr_distance2(nadh_cg, frac = 1) |> fastme.bal() |> root("Saimiri sciureus") |> plot()

cgr_distance2(nadh_cg, frac = 1/15) |> hm()
cgr_distance2(nadh_cg, frac = 1/15) |> bionj() |> root("Saimiri sciureus") |> plot()
cgr_distance2(nadh_cg, frac = 1/15) |> fastme.bal() |> root("Saimiri sciureus") |> plot()

cgr_distance2(sim_cg, frac = 1) |> hm()
cgr_distance2(sim_cg, frac = 1) |> bionj() |> plot()
cgr_distance2(sim_cg, frac = 1) |> fastme.bal() |> plot() 

cgr_distance2(sim_cg, frac = 1/15) |> hm()
cgr_distance2(sim_cg, frac = 1/15) |> bionj() |> plot()
cgr_distance2(sim_cg, frac = 1/15) |> fastme.bal() |> plot() 
  
```

```{r, eval = F}

#=====================================================================
# Volume intersection method results 
#=====================================================================

set.seed(0)

#This part of the code takes the longest to run. 
# Reduce samples.per.point and num.points.max to improve runtime or eliminate
# the parameters altogether to use default values of the hypervolume package


beta_tanimoto <- 
  volume_intersection_tanimoto(
    lapply(beta_cg, function(x) x[-1,]), # Drop the origin point
    hv_args = list(samples.per.point = 5000), 
    vi_args = list(num.points.max = 150000)
  ) 

beta_tanimoto |> (\(x) 1 - x)() |> bionj() |> ape::root("gallus") |> plot()

nadh_tanimoto <- 
  volume_intersection_tanimoto(
    lapply(nadh_cg, function(x) x[-1,]), # Drop the origin point
    hv_args = list(samples.per.point = 5000), 
    vi_args = list(num.points.max = 150000)
  ) 

nadh_tanimoto |> (\(x) 1 - x)() |> bionj() |> root("Saimiri sciureus") |> plot()

sim_tanimoto <- 
  volume_intersection_tanimoto(
    lapply(sim_cg, function(x) x[-1,]), # Drop the origin point
    hv_args = list(samples.per.point = 5000), 
    vi_args = list(num.points.max = 150000)) 

sim_tanimoto |> (\(x) 1 - x)()  |> bionj() |> plot()

```


```{r}

hm.vir <- function(distances, ...){
  dat <- distances |> as.matrix() |> reshape2::melt(value.name = "distance")
  # tri <- distances |> as.matrix() |> upper.tri(diag = T) |> reshape2::melt() |> pull(value)
  # dat <- dat[tri, , drop = F]
  dat |> 
    ggplot() + 
    geom_tile(aes(x = Var1, y = Var2, fill = distance)) + 
    scale_fill_viridis(option = "turbo", limits = c(0, 1), ...) +
    theme_light() + 
    theme(
      axis.text.x = element_text(angle = 90, vjust = .25, hjust = 1), 
      axis.title.x = element_blank(), 
      axis.title.y = element_blank(), 
      legend.position = "bottom"
    ) +
    coord_fixed()
}



align_plots1(
    clustal_omega(beta_seq) |> hm.vir(),
    cgr_distance2(beta_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> hm.vir(), 
    beta_tanimoto |> (\(x) 1 - x)()  |> (\(x) x / max(x))() |> hm.vir()
)

align_plots1(
  clustal_omega(nadh) |> hm.vir(),
  cgr_distance2(nadh_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> hm.vir(), 
  nadh_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> hm.vir() 
)

align_plots1(
  clustal_omega(sim_fas) |> hm.vir(),
  cgr_distance2(sim_cg, frac = 1/15, normalize = T)|> (\(x) x / max(x))()  |> hm.vir() , 
  sim_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> hm.vir()
)

```

```{r}


library(cowplot)

pdf("heatmaps.pdf", height = 18, width = 18)
plot_grid(
    clustal_omega(beta_seq) |> hm.vir() + theme(legend.position = "none"),
    cgr_distance2(beta_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> hm.vir()+ theme(legend.position = "none"), 
    beta_tanimoto |> (\(x) 1 - x)()  |> (\(x) x / max(x))() |> hm.vir()+ theme(legend.position = "right"),
    clustal_omega(nadh) |> hm.vir()+ theme(legend.position = "none"),
    cgr_distance2(nadh_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> hm.vir()+ theme(legend.position = "none"), 
    nadh_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> hm.vir() + theme(legend.position = "right") ,
    clustal_omega(sim_fas) |> hm.vir() + theme(legend.position = "none"),
    cgr_distance2(sim_cg, frac = 1/15, normalize = T)|> (\(x) x / max(x))()  |> hm.vir() + theme(legend.position = "none"), 
    sim_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> hm.vir() + theme(legend.position = "right"),
    align = "hv", axis = "lr", ncol = 3
)
dev.off()

```

```{r}
ggsave("heatmaps.png", width = 21, height = 21, dpi = 600)
```

```{r}

library(ggtree)
library(patchwork)

plot_grid(
  clustal_omega(beta_seq) |> bionj() |> root("gallus") |> ggtree() + geom_tiplab()+ coord_cartesian(xlim = c(0, .65)),
  cgr_distance2(beta_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> bionj() |> root("gallus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, .65)), 
  beta_tanimoto |> (\(x) 1 - x)() |> bionj() |> ape::root("gallus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, .65)),
  clustal_omega(nadh) |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, .75)),
  cgr_distance2(nadh_cg, frac = 1/15) |> (\(x) x / max(x))() |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, .75)),
  nadh_tanimoto |> (\(x) 1 - x)() |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, .75)),
  clustal_omega(sim_fas) |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1)),
  cgr_distance2(sim_cg, frac = 1/15) |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1)),
  sim_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1)),
  align = "hv", axis = "lr", ncol = 3
)

  (clustal_omega(beta_seq) |> bionj() |> root("gallus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (cgr_distance2(beta_cg, frac = 1/15, normalize = T) |> (\(x) x / max(x))() |> bionj() |> root("gallus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (beta_tanimoto |> (\(x) 1 - x)() |> bionj() |> ape::root("gallus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (clustal_omega(nadh) |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (cgr_distance2(nadh_cg, frac = 1/15) |> (\(x) x / max(x))() |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (nadh_tanimoto |> (\(x) 1 - x)() |> bionj() |> root("Saimiri sciureus") |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (clustal_omega(sim_fas) |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (cgr_distance2(sim_cg, frac = 1/15) |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + 
  (sim_tanimoto |> (\(x) 1 - x)() |> (\(x) x / max(x))() |> bionj() |> ggtree() + geom_tiplab() + coord_cartesian(xlim = c(0, 1))) + patchworkL::plot_layout(ncol = 3)


```

```{r}

ggsave("trees.png", width = 35, height = 21, dpi = 600)

```

```{r}

#=====================================================================
# Demonstrative plots in the paper
#=====================================================================

# Code for 2D chaos game example 
seq_to_2Dcg <- function(dna_seq, plot=F, ...){
  A <- c(0, 0)
  C <- c(0, 1)
  G <- c(1, 1)
  T <- c(1, 0)
  if(length(dna_seq) == 1) dna_seq <- str_split(dna_seq, "")[[1]]
  cg_x <- c(1/2)
  cg_y <- c(1/2)
  for(i in seq_along(dna_seq)){
    cg_x <- c(cg_x, mean(c(cg_x[length(cg_x)], get(dna_seq[i])[1])))
    cg_y <- c(cg_y, mean(c(cg_y[length(cg_y)], get(dna_seq[i])[2])))
  }
  xy <- data.frame(cg_x, cg_y, nucleotide = c("-", dna_seq)) |> 
    rownames_to_column() |> 
    mutate(position = as.numeric(rowname)-1,
           subsequence = "") 
  
  for(i in 2:nrow(xy)){
    xy[["subsequence"]][i] <- paste(xy[["subsequence"]][i-1], xy[["nucleotide"]][i] )
  }
  
  return(xy)
}

# Figure 1.2 An example of 2D chaos game representation for ATGG
rows <- 5
seq_to_2Dcg(beta_seq[[1]]) |> head(rows) |> 
  ggplot(aes(label = subsequence, x = cg_x, y = cg_y)) + 
  geom_text(position = position_nudge(x = -.05)) +
  geom_path(aes(col = as.numeric(rowname)), 
            arrow = arrow(ends = "last", type = "closed", 
                          length = unit(c(rep(.15, rows), 0.25), "inches")), 
            alpha = .75) +
  coord_fixed(xlim = c(0, 1), ylim = c(0, 1)) +
  theme_minimal() + xlab(NULL) + ylab(NULL) +
  guides(col = "none") + 
  annotate(geom = "text", 
           label = c("A", "C", "G", "T"), 
           x = c(0, 0, 1, 1), y = c(0, 1, 1, 0), size = 7) 


# Figure 2.1. 3D CGR of the MT-NADH for the Macaca fascicular
for_plotly <- seq_to_cgr(nadh[[1]])%>% as.data.frame() %>% rownames_to_column() %>% 
    dplyr::rename(position = rowname) %>% mutate(position = as.numeric(position))
fig <- plotly::plot_ly(for_plotly, x = ~i, y = ~j, z = ~k, 
                       size = I(1000), marker = list(line=list(width=0)), color = ~position, opacity = .85)
fig <- fig %>% plotly::add_markers()
fig %>% 
    plotly::config(
        toImageButtonOptions = list(
            format = "png",
            filename = "myplot2",
            width = 1000 * .75,
            height = 750* .75, scale = 2
        )
    )

# Figure 3.2 Sequence alignment of the CDS of theÎ²-globin gene for the chimp, human, and rabbit
alignment_to_vector <- function(alignment){
  output <- alignment$seq
  names(output) <- alignment$nam
  return(output)
}
msa(beta_seq[c("chimp", "human", "rabbit")], type = "dna", method = "ClustalOmega") %>% 
  msaConvert(., type = "seqinr::alignment") |> 
  alignment_to_vector() |> DNAStringSet() |> 
  ggmsa::ggmsa( 1, 52, 
                color = "Shapely_NT", font = "DroidSansMono", char_width = 0.5, 
                seq_name = T, consensus_views = T  ) 
msa(beta_seq[c("chimp", "human", "rabbit")], type = "dna", method = "ClustalOmega") %>% 
  msaConvert(., type = "seqinr::alignment") |> 
  alignment_to_vector() |> DNAStringSet() |> 
  ggmsa::ggmsa( 53, 105, 
                color = "Shapely_NT", font = "DroidSansMono", char_width = 0.5,
                seq_name = T, consensus_views = T  ) 
